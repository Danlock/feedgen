<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="css/main.css" />
  <title>Feedgen</title>
  <meta name="description" content="Generates RSS, Atom, and JSON feeds for manga">
</head>

<body>
  <div>
    <p class="center-me">
      Feedgen generates RSS, Atom and JSON feeds for manga releases. </br>
      Hit the Make Feed button after entering all the manga you want to be part of your release feed. <br />
      The link can be used in QuiteRSS, Mozilla Thunderbird or any reader that accepts one of the feed types. <br />
      Release info is sourced from MangaUpdates periodically throughout the day.</br>
      View the source code <a href="https://github.com/Danlock/feedgen">here</a> </br>
    </p>
  </div>
  <div>
    <p class="center-me">
      <label for="manga-titles">Enter manga:</label>
      <input id="manga-titles">
      <button id="manga-title-add-button" onclick="addMangaTitle()">+</button>
    </p>
    <p class="center-me">
      <label for="feed-type">
        Feed type:
      </label>
      <select id="feed-type" value="rss">
        <option selected="selected">rss</option>
        <option>json</option>
        <option>atom</option>
      </select>
    </p>
    <div class="center-me"> <button id="manga-feed-gen-button" onclick="makeMangaFeed()">Make Feed</button> </div>
  </div>
  <p class="center-me">Current Feed: (click to remove)</p>
  <p id="manga-display" class="center-me"></p>
  <p id="results" class="center-me"></p>

  <script>
    const ENTER_CODE = 13
    const MAX_MANGA = 2048
    const mangaInput = document.getElementById("manga-titles");
    const feedTypeInput = document.getElementById("feed-type");
    const results = document.getElementById("results");
    const mangaDisplay = document.getElementById("manga-display");
    let mangaTitles = []

    mangaInput.addEventListener("keydown", (e) => {
      if (e.keyCode !== ENTER_CODE) {
        return;
      }
      addMangaTitle();
    })

    function addMangaTitle() {
      const title = mangaInput.value;
      if (title === "") {
        results.innerHTML = "Please enter your desired manga title";
        return;
      }
      mangaTitles.push(title);
      displayManga(mangaTitles);
      mangaInput.value = "";
    }

    function removeMangaTitle(e) {
      mangaTitles = mangaTitles.filter(m => {
        return m !== e.target.innerText;
      });
      displayManga(mangaTitles);
    }

    function displayManga(mangaTitles) {
      mangaDisplay.innerHTML = ""
      for (const m of mangaTitles) {
        const btn = document.createElement("button");
        btn.innerText = m;
        btn.onclick = removeMangaTitle;
        mangaDisplay.appendChild(btn);
      }
    }

    function makeMangaFeed() {
      addMangaTitle();
      if (mangaTitles.length === 0) {
        results.innerHTML = "Please enter at least one manga."
        return;
      }
      if (mangaTitles.length > MAX_MANGA) {
        results.innerHTML = "Each feed can only hold a maximum of " + MAX_MANGA + " titles.";
        return;
      }
      const Http = new XMLHttpRequest();
      Http.open("POST", '/api/feed/manga');
      Http.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
      Http.send(JSON.stringify({ "titles": mangaTitles }));
      Http.onreadystatechange = e => {
        if (Http.status < 200 && Http.status > 299) {
          results.innerHTML = "There was an error processing that request, try again later."
          return;
        } else if (Http.status === 404) {
          results.innerHTML =
            `Could not find ${Http.responseText}. The manga must be available at <a href="https://www.mangaupdates.com">mangaupdates</a>`;
          return;
        }
        mangaTitles = [];
        displayManga(mangaTitles);
        const feedURL = Http.responseText + "?feedType=" + feedTypeInput.value;
        results.innerHTML = `Your feed is hosted at <a href="${feedURL}">here</a>`;
      }
    }
  </script>
</body>

</html>